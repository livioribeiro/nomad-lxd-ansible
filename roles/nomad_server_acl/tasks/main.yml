---
- name: Bootstrap Nomad acl
  ansible.builtin.command:
    nomad acl bootstrap
      -address=https://localhost:4646
      -ca-cert=/etc/certs.d/ca.crt
      -client-cert=/opt/nomad/tls/cert.pem
      -client-key=/opt/nomad/tls/key.pem
      -t '{{ "{{" }} .SecretID {{ "}}" }}'
  register: acl_bootstrap_result
  changed_when:
    - acl_bootstrap_result.rc == 0
  failed_when:
    - acl_bootstrap_result.rc != 0
    - '"ACL bootstrap already done" not in acl_bootstrap_result.stderr'
  notify: Save Nomad root token
