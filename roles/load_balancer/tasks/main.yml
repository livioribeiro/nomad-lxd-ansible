---
- name: Install HAProxy
  ansible.builtin.apt:
    name: haproxy
    state: present
    update_cache: true

- name: Create HAProxy certs
  ansible.builtin.import_role:
    name: certs_server
  vars:
    owner: haproxy
    alt_names:
      - 'DNS:*.{{ external_domain }}'
      - 'DNS:*.{{ apps_subdomain }}.{{ external_domain }}'

- name: Combine HAProxy cert with private key
  ansible.builtin.shell:
    chdir: /etc/certs.d
    cmd: cat private_key.pem cert.pem > haproxy.pem
    creates: /etc/certs.d/haproxy.pem

- name: Copy Nomad cert with private key combined
  ansible.builtin.copy:
    content: |
      {{ lookup("file", ".tmp/certs/nomad_client/private_key.pem") }}
      {{ lookup("file", ".tmp/certs/nomad_client/cert.pem") }}
    dest: '/etc/certs.d/nomad.crt'
    owner: haproxy
    mode: "0600"
  notify: Restart HAProxy

- name: Copy HAProxy config
  ansible.builtin.template:
    src: haproxy.cfg.j2
    dest: /etc/haproxy/haproxy.cfg
    owner: haproxy
    mode: "0600"
  notify: Restart HAProxy
