---
- name: Generate certs
  hosts: localhost
  connection: local
  roles:
    - certs
    - encrypt_keys

- name: Servers deployment
  hosts: localhost
  connection: local
  tasks:
    - ansible.builtin.import_tasks: containers.yml

- name: Wait for servers to be ready
  hosts: localhost
  connection: local
  tasks:
    - name: Wait for servers to be ready
      ansible.builtin.wait_for:
        timeout: 30

- name: Setup Consul servers
  hosts: consul_servers
  roles:
    - ca_cert
    - hashicorp_apt
    - consul_server
    - consul_dns

- name: Initialize Consul acl
  hosts: consul_servers
  roles:
    - consul_server_acl

- name: Setup Vault servers
  hosts: vault_servers
  roles:
    - ca_cert
    - hashicorp_apt
    - consul_client
    - vault_server

- name: Initialize Vault
  hosts: vault-server1
  roles:
    - vault_server_init

- name: Unseal Vault
  hosts: vault_servers
  roles:
    - vault_server_unseal

- name: Initialize Vault PKI
  hosts: vault-server1
  roles:
    - vault_server_pki

- name: Setup Nomad servers
  hosts: nomad_servers
  roles:
    - ca_cert
    - hashicorp_apt
    - consul_client
    - nomad_server

- name: Initialize Nomad acl
  hosts: nomad-server1
  roles:
    - nomad_server_acl

- name: Setup NFS Server
  hosts: nfs-server
  roles:
    - nfs_server

- name: Setup load balancer
  hosts: load-balancer
  roles:
    - ca_cert
    - load_balancer

- name: Setup Nomad clients
  hosts: nomad_clients
  roles:
    - ca_cert
    - hashicorp_apt
    - consul_client
    - nomad_client

- name: Setup Nomad clients consul-template
  hosts: nomad_clients
  roles:
    - nomad_client_consul_template

- name: Setup nomad jobs
  hosts: localhost
  connection: local
  tasks:
    - name: Execute terraform
      community.general.terraform:
        project_path: ./terraform
        state: present
        force_init: true
        backend_config:
          address: '{{ hostvars["consul-server1"].ansible_host }}:8500'
          access_token: '{{ lookup("file", ".tmp/root_token_consul.txt") }}'
        variables:
          nfs_server_host: '{{ hostvars["nfs-server"].ansible_host }}'
          external_domain: '{{ external_domain }}'
          apps_subdomain: '{{ apps_subdomain }}'
          ca_cert: '{{ lookup("file", ".tmp/certs/ca.crt") }}'
          consul_address: '{{ hostvars["consul-server1"].ansible_host }}:8501'
          consul_scheme: https
          consul_token: '{{ lookup("file", ".tmp/root_token_consul.txt") }}'
          nomad_address: 'https://{{ hostvars["nomad-server1"].ansible_host}}:4646'
          nomad_secret_id: '{{ lookup("file", ".tmp/root_token_nomad.txt") }}'
          client_cert: '{{ lookup("file", ".tmp/certs/client.crt") }}'
          client_key: '{{ lookup("file", ".tmp/certs/client.key") }}'
          vault_address: 'https://{{ hostvars["vault-server1"].ansible_host }}:8200'
          vault_token: '{{ lookup("file", ".tmp/root_token_vault.txt") }}'
