---
- name: servers deployment
  hosts: localhost
  # run this task in the host
  connection: local
  tasks:
    - name: create server containers
      loop: "{{ groups['consul_servers'] + groups['nomad_servers'] }}"
      community.general.lxd_container:
        name: "{{ item }}"
        state: started
        source: &container_image_source
          type: image
          mode: pull
          server: https://images.linuxcontainers.org
          protocol: simplestreams
          alias: "ubuntu/{{ ubuntu_version }}/amd64"

    - name: create nomad client containers
      loop: "{{ groups['nomad_clients'] }}"
      community.general.lxd_container:
        name: "{{ item }}"
        state: started
        source: *container_image_source
        config:
          limits.cpu: "1"
          limits.memory: 3GB
          security.nesting: "true"
          security.privileged: "true"
          raw.lxc: |-
            lxc.apparmor.profile=unconfined
            lxc.cgroup.devices.allow=a
            lxc.cap.drop=

    - name: create nomad client infra containers
      community.general.lxd_container:
        name: nomad-client-infra1
        devices:
          map_port_80:
            type: proxy
            listen: tcp:0.0.0.0:80
            connect: tcp:127.0.0.1:80
          map_port_8080:
            type: proxy
            listen: tcp:0.0.0.0:8080
            connect: tcp:127.0.0.1:8080

    - name: create nfs server container
      community.general.lxd_container:
        name: nfs-server
        state: started
        source: *container_image_source
        config:
          security.privileged: "true"
          raw.apparmor: "mount fstype=rpc_pipefs, mount fstype=nfsd,"

- name: install consul service
  hosts: consul_servers:nomad_servers:nomad_clients
  roles:
    - hashicorp_apt
    - consul_service

- name: setup consul servers
  hosts: consul_servers
  roles:
    - consul_server
    - consul_dns

- name: setup consul clients
  hosts: nomad_servers:nomad_clients
  roles:
    - consul_client
    - consul_dns

# - name: setup vault
#   hosts: vault_servers
#   roles:
#     - vault_server
#     - consul_dns

- name: setup nfs server
  hosts: nfs-server
  roles:
    - nfs_server

- name: install nomad service
  hosts: nomad_servers:nomad_clients
  roles:
    - nomad_service

- name: setup nomad server
  hosts: nomad_servers
  roles:
    - nomad_server

- name: setup nomad client
  hosts: nomad_clients
  roles:
    - nomad_client

- name: run nomad jobs
  hosts: nomad-server1
  roles:
    - nomad_jobs