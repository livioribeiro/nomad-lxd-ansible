---
- name: servers deployment
  hosts: localhost
  # run this task in the host
  connection: local
  tasks:
    - ansible.builtin.import_tasks: servers.yml

- name: install consul service
  hosts: consul_servers:nomad_servers:nomad_clients
  roles:
    - hashicorp_apt
    - consul_service

- name: setup consul servers
  hosts: consul_servers
  roles:
    - consul_server
    - consul_dns

- name: setup consul clients
  hosts: nomad_servers:nomad_clients
  roles:
    - consul_client
    - consul_dns

# - name: setup vault
#   hosts: vault_servers
#   roles:
#     - vault_server
#     - consul_dns

- name: setup nfs server
  hosts: nfs-server
  roles:
    - nfs_server

- name: install nomad service
  hosts: nomad_servers:nomad_clients
  roles:
    - nomad_service

- name: setup nomad server
  hosts: nomad_servers
  roles:
    - nomad_server

- name: setup nomad client
  hosts: nomad_clients
  roles:
    - nomad_client

- name: setup load balancer
  hosts: load-balancer
  roles:
    - load_balancer

- name: setup nomad jobs
  hosts: localhost
  connection: local
  tasks:
    - name: execute terraform
      ansible.builtin.terraform:
        project_path: ./terraform
        state: present
        force_init: true
        variables:
          nomad_address: "http://{{ hostvars['nomad-server1'].ansible_default_ipv4.address }}:4646"